<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Ti·∫øn Tr√¨nh 4 Nh·ªãp/Gi√¢y</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Tone.js cho √¢m thanh -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- C·∫•u h√¨nh Font Inter v√† m√†u s·∫Øc -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* N·ªÅn x√°m nh·∫°t */
        }
        /* ƒê·ªãnh nghƒ©a animation rung nh·∫π cho nh·ªãp cu·ªëi */
        @keyframes pulse-once {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .animate-beat {
            animation: pulse-once 0.1s ease-in-out;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Th·∫ª bao ngo√†i ch√≠nh -->
    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">ƒê·ªìng H·ªì 4 Nh·ªãp/Gi√¢y (C√≥ B√≠p)</h1>
        
        <!-- Khu v·ª±c hi·ªÉn th·ªã th·ªùi gian v√† ti·∫øn tr√¨nh -->
        <div class="space-y-6">
            
            <!-- Hi·ªÉn th·ªã Th·ªùi gian s·ªë (Gi√¢y v√† Mili gi√¢y) -->
            <div class="flex flex-col items-center justify-center bg-indigo-50 p-4 rounded-lg">
                <p class="text-sm font-medium text-gray-600 uppercase tracking-wider">Th·ªùi Gian Hi·ªán T·∫°i (HH:MM:SS.ms)</p>
                <div id="time-display" class="text-5xl md:text-6xl font-extrabold text-indigo-700 mt-1">
                    00:00:00.000
                </div>
            </div>

            <!-- Thanh ti·∫øn tr√¨nh -->
            <div>
                <p class="text-lg font-semibold text-gray-700 mb-2">Ti·∫øn Tr√¨nh Nh·ªãp Hi·ªán T·∫°i (1 nh·ªãp = 250ms):</p>
                <div class="w-full bg-gray-200 rounded-full h-8 overflow-hidden shadow-inner">
                    <!-- Lo·∫°i b·ªè c√°c l·ªõp gradient c≈© v√† chu·∫©n b·ªã cho c√°c l·ªõp m√†u dynamic -->
                    <div id="progress-bar" 
                         class="h-8 transition-all duration-150 ease-linear rounded-full" 
                         style="width: 0%;">
                    </div>
                </div>
                <div id="ms-text" class="text-right text-sm font-mono mt-1 text-gray-600">Nh·ªãp: 0 | 0 ms</div>
            </div>
            
        </div>
        
        <!-- N√∫t k√≠ch ho·∫°t √¢m thanh -->
        <button id="start-button" class="mt-8 w-full py-3 text-lg font-semibold text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 transition duration-150 active:scale-95">
            üîä B·∫•m ƒë·ªÉ K√≠ch ho·∫°t √Çm thanh (Nh·ªãp B√≠p)
        </button>
    </div>

    <script>
        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM c·∫ßn thi·∫øt
        const progressBar = document.getElementById('progress-bar');
        const msText = document.getElementById('ms-text');
        const timeDisplay = document.getElementById('time-display');
        const startButton = document.getElementById('start-button');
        
        // Bi·∫øn Tone.js v√† tr·∫°ng th√°i nh·ªãp
        let beatSynth = null;
        let lastBeatIndex = -1;
        let isAudioContextStarted = false;

        /**
         * H√†m padding: Th√™m s·ªë 0 v√†o ƒë·∫ßu n·∫øu c·∫ßn
         */
        function pad(num, size) {
            let s = "000" + num;
            return s.substring(s.length - size);
        }

        /**
         * H√†m kh·ªüi t·∫°o v√† b·∫Øt ƒë·∫ßu Audio Context
         */
        function startAudio() {
            // B·∫Øt ƒë·∫ßu Tone.js (c·∫ßn t∆∞∆°ng t√°c ng∆∞·ªùi d√πng)
            Tone.start().then(() => {
                // Kh·ªüi t·∫°o Synth cho √¢m thanh 'b√≠p'
                beatSynth = new Tone.Synth({
                    oscillator: { type: "square" }, // √Çm thanh ƒë∆°n gi·∫£n, r√µ r√†ng
                    envelope: {
                        attack: 0.005,
                        decay: 0.05,
                        sustain: 0.01,
                        release: 0.05
                    }
                }).toDestination();
                
                // ƒê·∫∑t c·ªù tr·∫°ng th√°i
                isAudioContextStarted = true;
                
                // ·∫®n n√∫t sau khi kh·ªüi ƒë·ªông th√†nh c√¥ng
                startButton.style.display = 'none';
                console.log("Audio Context ƒë√£ ƒë∆∞·ª£c kh·ªüi ƒë·ªông.");

            }).catch(e => {
                console.error("L·ªói kh·ªüi t·∫°o √¢m thanh Tone.js:", e);
                startButton.textContent = "L·ªói √¢m thanh! Vui l√≤ng t·∫£i l·∫°i trang.";
                startButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                startButton.classList.add('bg-red-600');
            });
        }
        
        startButton.addEventListener('click', startAudio);


        /**
         * C·∫≠p nh·∫≠t hi·ªÉn th·ªã th·ªùi gian, nh·ªãp v√† thanh ti·∫øn tr√¨nh
         */
        function updateProgress() {
            const now = new Date();
            
            // 1. T√≠nh to√°n Mili gi√¢y
            const milliseconds = now.getMilliseconds();
            
            // 2. T√≠nh to√°n Nh·ªãp (Beat)
            const beatDuration = 250; // 1000ms / 4 nh·ªãp
            
            // X√°c ƒë·ªãnh nh·ªãp hi·ªán t·∫°i (0, 1, 2, ho·∫∑c 3)
            const currentBeatIndex = Math.floor(milliseconds / beatDuration);
            
            // S·ªë nh·ªãp hi·ªÉn th·ªã cho ng∆∞·ªùi d√πng (1, 2, 3, ho·∫∑c 4)
            const displayBeat = currentBeatIndex + 1;

            // 3. T√≠nh to√°n Ph·∫ßn trƒÉm (R·ªùi r·∫°c)
            const discretePercentage = displayBeat * 25; // 25%, 50%, 75%, 100%

            // 4. C·∫≠p nh·∫≠t Thanh Ti·∫øn tr√¨nh Width
            progressBar.style.width = discretePercentage + '%';
            
            // 5. LOGIC √ÇM THANH
            if (currentBeatIndex !== lastBeatIndex) {
                // Ch·ªâ ph√°t √¢m thanh khi nh·ªãp thay ƒë·ªïi
                if (isAudioContextStarted && beatSynth) {
                    // C·∫¨P NH·∫¨T: Ch·ªâ ph√°t √¢m thanh ·ªü Nh·ªãp 2 (index 1) v·ªõi n·ªët D5.
                    if (currentBeatIndex === 1) {
                        beatSynth.triggerAttackRelease("D5", "16n"); // Ph√°t n·ªët D5
                    }
                    // C√°c nh·ªãp kh√°c (0, 2, 3) s·∫Ω im l·∫∑ng.
                }
                lastBeatIndex = currentBeatIndex;
            }
            
            // 6. LOGIC M√ÄU & HI·ªÜU ·ª®NG (Traffic Light Logic)
            
            // Lo·∫°i b·ªè t·∫•t c·∫£ c√°c l·ªõp m√†u c≈© tr∆∞·ªõc khi √°p d·ª•ng m√†u m·ªõi
            progressBar.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-orange-500', 'bg-red-600', 'animate-beat');

            switch (displayBeat) {
                case 1:
                    progressBar.classList.add('bg-green-500'); // Xanh L√°
                    break;
                case 2:
                    progressBar.classList.add('bg-yellow-500'); // V√†ng
                    break;
                case 3:
                    progressBar.classList.add('bg-orange-500'); // Cam
                    break;
                case 4:
                    progressBar.classList.add('bg-red-600', 'animate-beat'); // ƒê·ªè
                    break;
            }
            // -------------------------------------------------------------

            // 7. C·∫≠p nh·∫≠t vƒÉn b·∫£n hi·ªÉn th·ªã
            msText.textContent = `Nh·ªãp: ${displayBeat} | ${pad(milliseconds, 3)} ms`;

            // 8. C·∫≠p nh·∫≠t hi·ªÉn th·ªã th·ªùi gian ƒë·∫ßy ƒë·ªß
            const hours = pad(now.getHours(), 2);
            const minutes = pad(now.getMinutes(), 2);
            const seconds = pad(now.getSeconds(), 2);
            const msPadded = pad(milliseconds, 3);
            
            timeDisplay.textContent = `${hours}:${minutes}:${seconds}.${msPadded}`;

            // Y√™u c·∫ßu tr√¨nh duy·ªát c·∫≠p nh·∫≠t l·∫°i
            requestAnimationFrame(updateProgress);
        }

        // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p c·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
        updateProgress();
    </script>
</body>
</html>
